#!/usr/bin/env python3
"""
åœæ­¢æ‰€æœ‰ Tushare Query MCP ç›¸å…³æœåŠ¡
"""

import subprocess
import sys
import time
import signal
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))


def print_status(msg: str, status: str = "info"):
    """æ‰“å°çŠ¶æ€ä¿¡æ¯"""
    symbols = {
        "info": "â„¹ï¸",
        "success": "âœ…",
        "error": "âŒ",
        "warning": "âš ï¸",
        "start": "ğŸš€"
    }
    symbol = symbols.get(status, "â„¹ï¸")
    print(f"{symbol} {msg}")


def find_processes():
    """æŸ¥æ‰¾ç›¸å…³è¿›ç¨‹"""
    processes = []

    try:
        # æŸ¥æ‰¾ uvicorn è¿›ç¨‹
        result = subprocess.run(
            ["pgrep", "-f", "uvicorn.*tushare_query_mcp"],
            capture_output=True, text=True
        )
        if result.stdout.strip():
            for pid in result.stdout.strip().split('\n'):
                processes.append(('uvicorn', int(pid)))
    except FileNotFoundError:
        pass

    try:
        # æŸ¥æ‰¾ start_server.py è¿›ç¨‹
        result = subprocess.run(
            ["pgrep", "-f", "python.*start_server.py"],
            capture_output=True, text=True
        )
        if result.stdout.strip():
            for pid in result.stdout.strip().split('\n'):
                processes.append(('start_server', int(pid)))
    except FileNotFoundError:
        pass

    try:
        # æŸ¥æ‰¾ start.py è¿›ç¨‹
        result = subprocess.run(
            ["pgrep", "-f", "python.*start.py"],
            capture_output=True, text=True
        )
        if result.stdout.strip():
            for pid in result.stdout.strip().split('\n'):
                processes.append(('start', int(pid)))
    except FileNotFoundError:
        pass

    return processes


def stop_process(pid: int, name: str) -> bool:
    """åœæ­¢å•ä¸ªè¿›ç¨‹"""
    try:
        # é¦–å…ˆå°è¯•ä¼˜é›…ç»ˆæ­¢
        os.kill(pid, signal.SIGTERM)

        # ç­‰å¾…è¿›ç¨‹ç»“æŸ
        for _ in range(5):
            try:
                os.kill(pid, 0)  # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜åœ¨
                time.sleep(1)
            except OSError:
                print_status(f"æˆåŠŸåœæ­¢ {name} è¿›ç¨‹ (PID: {pid})", "success")
                return True

        # å¦‚æœè¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå¼ºåˆ¶ç»ˆæ­¢
        os.kill(pid, signal.SIGKILL)
        print_status(f"å¼ºåˆ¶åœæ­¢ {name} è¿›ç¨‹ (PID: {pid})", "warning")
        return True

    except OSError as e:
        if e.errno == 3:  # No such process
            print_status(f"{name} è¿›ç¨‹ (PID: {pid}) å·²ä¸å­˜åœ¨", "info")
            return True
        else:
            print_status(f"åœæ­¢ {name} è¿›ç¨‹ (PID: {pid}) å¤±è´¥: {e}", "error")
            return False


def stop_port_users():
    """åœæ­¢å ç”¨8000ç«¯å£çš„è¿›ç¨‹"""
    try:
        result = subprocess.run(
            ["lsof", "-ti", ":8000"],
            capture_output=True, text=True
        )
        if result.stdout.strip():
            pids = result.stdout.strip().split('\n')
            print_status(f"å‘ç°å ç”¨8000ç«¯å£çš„è¿›ç¨‹: {', '.join(pids)}", "warning")

            for pid in pids:
                try:
                    os.kill(int(pid), signal.SIGTERM)
                    print_status(f"åœæ­¢å ç”¨8000ç«¯å£çš„è¿›ç¨‹ (PID: {pid})", "success")
                except (OSError, ValueError):
                    pass
    except (FileNotFoundError, subprocess.SubprocessError):
        pass


def main():
    """ä¸»å‡½æ•°"""
    print_status("Tushare Query MCP æœåŠ¡åœæ­¢å™¨", "start")
    print("=" * 50)

    # æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³è¿›ç¨‹
    processes = find_processes()

    if not processes:
        print_status("æ²¡æœ‰å‘ç°è¿è¡Œä¸­çš„ç›¸å…³æœåŠ¡", "info")
        print_status("æ£€æŸ¥ç«¯å£å ç”¨æƒ…å†µ...", "info")
        stop_port_users()
        print_status("æ‰€æœ‰æœåŠ¡å·²åœæ­¢", "success")
        return

    print_status(f"å‘ç° {len(processes)} ä¸ªç›¸å…³è¿›ç¨‹:", "info")
    for name, pid in processes:
        print(f"  - {name}: PID {pid}")
    print("")

    # åœæ­¢æ‰€æœ‰è¿›ç¨‹
    stopped_count = 0
    for name, pid in processes:
        if stop_process(pid, name):
            stopped_count += 1

    # é¢å¤–æ£€æŸ¥ç«¯å£å ç”¨
    stop_port_users()

    # ç­‰å¾…ä¸€ä¸‹è®©è¿›ç¨‹å®Œå…¨ç»“æŸ
    time.sleep(2)

    # æœ€ç»ˆæ£€æŸ¥
    remaining_processes = find_processes()
    if remaining_processes:
        print_status(f"è­¦å‘Š: ä»æœ‰ {len(remaining_processes)} ä¸ªè¿›ç¨‹æœªåœæ­¢", "warning")
        for name, pid in remaining_processes:
            print(f"  - {name}: PID {pid}")
    else:
        print_status(f"æˆåŠŸåœæ­¢æ‰€æœ‰ {stopped_count} ä¸ªè¿›ç¨‹", "success")

    print_status("æœåŠ¡åœæ­¢å®Œæˆ", "success")


if __name__ == "__main__":
    main()