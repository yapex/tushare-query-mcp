# Tushare MCP 架构设计与决策

**最后更新**: 2025-11-05
**状态**: ✅ **生产就绪 (Production Ready)**
**覆盖**: 架构设计、技术选型、实施决策

## 项目概述

实现智能字段返回的 MCP 服务，让 Claude Code 能高效查询中国股票财务数据。

## 🏗️ 整体架构

```
用户请求 (Claude Code/HTTP)
    ↓
统一接口层 (FastAPI路由 / MCP工具)
    ↓
业务逻辑层 (四大Service)
    ↓
缓存层 (diskcache持久化缓存)
    ↓
数据访问层 (TushareDataSource)
    ↓
外部API (Tushare Pro)
```

## 📊 核心功能特性

### 1. 智能字段选择
- 按需返回字段，大幅节省 token 使用
- 支持任意字段组合
- 自动缓存不同字段组合

### 2. 持久化缓存
- 使用 diskcache 实现磁盘持久化
- 服务重启后缓存依然有效
- 智能过期策略（财务数据7天，基本信息30天）

### 3. 双模式支持
- **FastAPI REST API**：标准 HTTP 接口
- **MCP 工具**：Claude Code 原生集成

## 🛠️ 技术栈与选型决策

### Web框架: FastAPI
**决策理由**:
- 原生支持 Pydantic 模型，参数验证更简洁
- 自动生成 Swagger/OpenAPI 文档
- 高性能（异步支持）
- 类型提示友好
- 适合微服务架构

**影响**:
- 需要 uvicorn 作为 ASGI 服务器
- 更好的可维护性
- 学习曲线略高于 Flask

### 数据模型: Pydantic v2
**决策理由**:
- 强大的数据验证和序列化
- 类型提示集成
- 性能优异
- 自动 API 文档生成

**影响**:
- 需要编写详细的字段定义
- 与 FastAPI 深度集成
- 自动参数验证和错误处理

### 依赖管理: uv
**决策理由**:
- 更快的依赖安装
- 更好的锁定机制
- 轻量级虚拟环境管理

**影响**:
- 所有命令使用 `uv run` 前缀
- 需要遵循 uv 约定
- 更好的依赖解析性能

### 缓存系统: diskcache
**决策理由**:
- 持久化到磁盘，服务重启不丢失
- 高性能并发访问
- 简洁的 API

**替代方案考虑**:
- Redis：需要额外服务，复杂度高
- 内存缓存：服务重启丢失

## 🔧 架构层次详解

### 1. 接口层 (API Layer)
- **FastAPI路由**: 13个REST API端点
- **MCP工具**: 3个原生集成工具
- **统一响应格式**: 标准化API响应

### 2. 业务逻辑层 (Service Layer)
- **IncomeService**: 利润表数据处理
- **BalanceService**: 资产负债表数据处理
- **CashFlowService**: 现金流量表数据处理
- **StockService**: 股票基本信息处理

### 3. 数据访问层 (Data Source Layer)
- **TushareDataSource**: 统一的数据源接口
- **异步调用**: 非阻塞API调用
- **错误处理**: 统一异常处理机制

### 4. 缓存层 (Cache Layer)
- **时间基础过期**: 7-30天智能过期
- **键值策略**: 基于请求参数的缓存键
- **并发安全**: 支持高并发访问

## 🎯 设计原则

### 1. 分层架构
清晰的职责分离，每层只关心自己的功能
- 接口层：请求处理和响应格式化
- 业务层：数据处理和业务逻辑
- 数据层：外部API调用和缓存

### 2. 单一职责
每个类和模块都有明确的单一职责
- Service只处理业务逻辑
- DataSource只负责数据获取
- 工具类提供可重用功能

### 3. 依赖注入
使用依赖注入模式，提高可测试性
- FastAPI的Depends系统
- 便于单元测试和集成测试

### 4. 配置外部化
所有配置通过环境变量管理
- 支持不同环境配置
- 敏感信息安全存储

## 📈 性能优化

### 1. 缓存策略
- **多级缓存**: 内存 + 磁盘持久化
- **智能过期**: 根据数据类型设置不同TTL
- **并发缓存**: 支持高并发读写

### 2. 异步处理
- **全异步架构**: 避免阻塞调用
- **并发数据获取**: 同时请求多种财务数据
- **连接池**: 复用HTTP连接

### 3. 数据优化
- **字段选择**: 只返回需要的字段
- **数据过滤**: 客户端和服务端双重过滤
- **分页支持**: 大数据集分页处理

## 🛡️ 安全考虑

### 1. API安全
- **Token管理**: 安全的Tushare Token存储
- **输入验证**: Pydantic自动参数验证
- **错误处理**: 不暴露敏感信息

### 2. 数据安全
- **环境变量**: 敏感配置外部化
- **缓存隔离**: 不同数据类型隔离存储
- **日志脱敏**: 敏感信息不记录日志

## 🧪 测试策略

### 1. 分层测试
- **单元测试**: 每个类和函数的独立测试
- **集成测试**: Service和DataSource集成测试
- **端到端测试**: 完整API流程测试

### 2. Mock测试
- **外部API**: 使用Mock避免实际API调用
- **缓存测试**: 测试缓存行为而不依赖真实缓存
- **错误场景**: 测试各种异常情况

## 📋 部署架构

### 开发环境
- **本地开发**: uv run + uvicorn
- **热重载**: 代码变更自动重启
- **调试支持**: 详细错误信息和日志

### 生产环境
- **容器化**: Docker支持
- **反向代理**: Nginx/traefik
- **监控**: 健康检查和性能监控

## 🔮 扩展性考虑

### 1. 水平扩展
- **无状态设计**: Service层无状态
- **缓存共享**: 多实例共享缓存
- **负载均衡**: 支持多实例部署

### 2. 功能扩展
- **插件架构**: 易于添加新的数据源
- **配置驱动**: 通过配置添加新功能
- **API版本控制**: 向后兼容的API演进